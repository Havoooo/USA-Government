#!/bin/bash

# doesn't check for the existence of the the thumbnail of an uploaded file

export HTTPS_TEST_URL="https://www.pandemicoversight.gov/version.txt";
export AWS_S3_DOMAIN="s3-us-gov-west-1.amazonaws.com";
export AWS_TEST_URL="https://${AWS_S3_DOMAIN}";
export EXISTING_BETA_FILE_FROM_S3="https://beta.usa.gov/themes/custom/usagov/images/LOGO_betasite_USAGOV_v2.png";
export EXISTING_CMS_FILE_FROM_S3="https://cms.usa.gov/s3/files/2022-03/Banner_img_Housing.png";
export EXISTING_LOCAL_FILE="2022-03/Banner_img_Housing.png";
# export EXISTING_LOCAL_FILE="2022-12/retro-bg-2.png";
export TEST_FILE_FOR_S3="test.txt";
export AWS_TEST_URL_FOR_DEV="https://cg-cd5efae4-00e9-4b94-afac-63ba9e871b93.s3-fips.us-gov-west-1.amazonaws.com/cms/public/${TEST_FILE_FOR_S3}";
export RUNTIME=$(date);

function runTests {
  # run all the tests
  # getInfoPHPWrappers;
  # getInfoPHPTransports;
  # getInfoDrupalWrappers;
  # getInfoDrupalTransports;
  # testThatDrupalCanReachAWS;
  testDrupalStreamWrapperPublic;
  # testDrupalStreamWrapperPrivate;
  # testDrupalStreamWrapperS3;
  # testDrupalStreamWrapperHTTPS;
  testThatPHPCanReachAWS;
  # testThatCurlCanReachAWS;
  # testThatAWSClientCanReachAWS;
  # testDrupalImageDerivationPublic;
  # testDrupalImageDerivationS3;
}

function testThatCurlCanReachAWS {
  # curl can reach aws host from the commandline
  echo cf ssh cms -c ". /etc/profile; . /var/www/scripts/setup-aws-cli.sh; curl -skI https://\${S3_BUCKET}.${AWS_S3_DOMAIN};"
  cf ssh cms -c ". /etc/profile; . /var/www/scripts/setup-aws-cli.sh; curl -skI https://\${S3_BUCKET}.${AWS_S3_DOMAIN};"
}


function testThatAWSClientCanReachAWS {
  # aws client can reach aws from the commandline
  echo cf ssh cms -c ". /etc/profile; . /var/www/scripts/setup-aws-cli.sh; aws s3 ls s3://\${BUCKET_NAME};"
  cf ssh cms -c ". /etc/profile; . /var/www/scripts/setup-aws-cli.sh; aws s3 ls s3://\${BUCKET_NAME};"
}

function testThatNGINXCanReadS3 {
  # nginx can respond with proxies files living in s3
  echo cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"\$client = \Drupal::httpClient; \$response = \$client->get('$EXISTING_BETA_FILE_FROM_S3'); print_r(\$response); echo \"\nStatus Code: \".\$response->getStatusCode.\"\n\";"
  cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"\$client = \Drupal::httpClient; \$response = \$client->get('$EXISTING_BETA_FILE_FROM_S3'); print_r(\$response); echo \"\nStatus Code: \".\$response->getStatusCode.\"\n\";"
}

function testThatPHPCanReachAWS {
  echo "Expecting to read from $AWS_TEST_URL_FOR_DEV (written by another test)"
  # php can read a file from AWS without Drupal
  echo cf ssh cms -c ". /etc/profile; php -r \"print_r(file_get_contents('$AWS_TEST_URL_FOR_DEV'));\""
  cf ssh cms -c ". /etc/profile; php -r \"print_r(file_get_contents('$AWS_TEST_URL_FOR_DEV'));\""
}

function testThatDrupalCanReachAWS {
  # drupal can initiate a connection to aws through drush
  echo cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"\$client = \Drupal::httpClient; \$response = \$client->get('$AWS_TEST_URL'); print_r(\$response); echo \"\nStatus Code: \".\$response->getStatusCode.\"\n\";"
  cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"\$client = \Drupal::httpClient; \$response = \$client->get('$AWS_TEST_URL'); print_r(\$response); echo \"\nStatus Code: \".\$response->getStatusCode.\"\n\";"
}

function testDrupalStreamWrapperS3 {
  # drupal can use the s3:// stream wrapper to read and write to s3
  echo "Expecting to write and read $RUNTIME to s3://$TEST_FILE_FOR_S3"

  echo cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"var_dump(file_put_contents('s3://public/$TEST_FILE_FOR_S3','$RUNTIME'));\""
  cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"var_dump(file_put_contents('s3://public/$TEST_FILE_FOR_S3','$RUNTIME'));\""

  echo cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"var_dump(file_get_contents('s3://public/$TEST_FILE_FOR_S3'));\""
  cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"var_dump(file_get_contents('s3://public/$TEST_FILE_FOR_S3'));\""
  # independantly check for existance of the file via aws cli
}


function testDrupalStreamWrapperPublic {
  echo "Expecting to write and read $RUNTIME to public://$TEST_FILE_FOR_S3"
  # drupal can use the public:// stream wrapper to read and write to s3

  echo cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"var_dump(file_put_contents('public://$TEST_FILE_FOR_S3','$RUNTIME'));\""
  cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"var_dump(file_put_contents('public://$TEST_FILE_FOR_S3','$RUNTIME'));\""

  echo cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"var_dump(file_get_contents('public://$TEST_FILE_FOR_S3'));\""
  cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"var_dump(file_get_contents('public://$TEST_FILE_FOR_S3'));\""

  # independantly check for existance of the file via aws cli
}

function testDrupalStreamWrapperPrivate {
  echo
  echo "Expecting to write and read $RUNTIME to private://$TEST_FILE_FOR_S3"
  # drupal can use the private:// stream wrapper to read and write to s3

  echo cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"var_dump(file_put_contents('private://$TEST_FILE_FOR_S3','$RUNTIME'));\""
  cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"var_dump(file_put_contents('private://$TEST_FILE_FOR_S3','$RUNTIME'));\""

  echo cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"var_dump(file_get_contents('private://$TEST_FILE_FOR_S3'));\""
  cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"var_dump(file_get_contents('private://$TEST_FILE_FOR_S3'));\""

  echo cf logs cms --recent | tail -n 10
  cf logs cms --recent | tail -n 10

  # independantly check for existance of the file via aws cli
}

function testDrupalStreamWrapperHTTPS {
  echo "Expecting to read a SEMVER vX.Y.Z from $HTTPS_TEST_URL"
  # drupal can use the https:// stream wrapper to read to a non-s3 file
  cf ssh cms -c ". /etc/profile; drush ev --root=/var/www/ \"var_dump(file_get_contents('$HTTPS_TEST_URL'));\""
}


function testDrupalImageDerivationPublic {
  echo "Expecting Drush to generate a thumbnail for $EXISTING_LOCAL_FILE"

  echo cf ssh cms -c ". /etc/profile; drush --root=/var/www/ image-derive thumbnail public://$EXISTING_LOCAL_FILE"
  cf ssh cms -c ". /etc/profile; drush --root=/var/www/ image-derive thumbnail public://$EXISTING_LOCAL_FILE"
}
function testDrupalImageDerivationS3 {
  echo "Expecting Drush to generate a thumbnail for $EXISTING_LOCAL_FILE"

  echo cf ssh cms -c ". /etc/profile; drush --root=/var/www/ image-derive thumbnail s3://public/$EXISTING_LOCAL_FILE"
  cf ssh cms -c ". /etc/profile; drush --root=/var/www/ image-derive thumbnail s3://public/$EXISTING_LOCAL_FILE"
}



function getInfoPHPTransports {
  echo
  echo "PHP stream_get_transports:"
  echo cf ssh cms -c '. /etc/profile; php -r "print_r(stream_get_transports());"'
  cf ssh cms -c '. /etc/profile; php -r "print_r(stream_get_transports());"'
}

function getInfoPHPWrappers {
  echo
  echo "PHP stream_get_wrappers:"
  echo cf ssh cms -c '. /etc/profile; php -r "print_r(stream_get_wrappers());"'
  cf ssh cms -c '. /etc/profile; php -r "print_r(stream_get_wrappers());"'
}

function getInfoDrupalTransports {
  echo
  echo "PHP stream_get_transports via drush:"
  echo cf ssh cms -c '. /etc/profile; drush ev --root=/var/www/ "print_r(stream_get_transports());"'
  cf ssh cms -c '. /etc/profile; drush ev --root=/var/www/ "print_r(stream_get_transports());"'
}

function getInfoDrupalWrappers {
  echo
  echo "PHP stream_get_wrappers via drush:"
  echo cf ssh cms -c '. /etc/profile; drush ev --root=/var/www/ "print_r(stream_get_wrappers());"'
  cf ssh cms -c '. /etc/profile; drush ev --root=/var/www/ "print_r(stream_get_wrappers());"'
}


runTests;
