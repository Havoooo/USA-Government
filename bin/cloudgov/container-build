#!/bin/sh
#
# This script will attempt to create a container image
# to be used when launching cloud.gov images
#
# Usage: ./container-build waf|cms [[primary user-provided docker tag] [secondary user-provided docker tag]]
#
# Note:  1. If the primary docker tag is used, no git arguments are extracted, therefore the docker build
#        command has some empty arguments - untested.
#
#        2. The second docker tag is only effective if the first tag is provided as well.
#

[ -f ./local-envs-rc ] && . ./local-envs-rc
[ -f ./container-type-rc ] && . ./container-type-rc

echo "Building ${DOCKERUSER}/${DOCKERREPO}:${CONTAINERTYPE}-${CONTAINERTAG} ${CONTAINERTAG2}"

chmod -R u+w ./web/sites/default/

docker build --force-rm \
     -t $DOCKERUSER/$DOCKERREPO:${CONTAINERTYPE}-$CONTAINERTAG \
     -f .docker/Dockerfile-${CONTAINERTYPE} . \
     --build-arg GITBRANCH=$GITBRANCH \
     --build-arg GITCOMMIT=$GITCOMMIT \
     --build-arg GITTAG=$GITTAG \
     --build-arg CONTAINERTAG=$CONTAINERTAG

if [ -n "$CONTAINERTAG2" ]
then
     echo "docker tag $DOCKERUSER/$DOCKERREPO:${CONTAINERTYPE}-$CONTAINERTAG \
        $DOCKERUSER/$DOCKERREPO:${CONTAINERTYPE}-$CONTAINERTAG2"
     docker tag $DOCKERUSER/$DOCKERREPO:${CONTAINERTYPE}-$CONTAINERTAG \
        $DOCKERUSER/$DOCKERREPO:${CONTAINERTYPE}-$CONTAINERTAG2
fi
